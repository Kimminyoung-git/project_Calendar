<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FullCalendar</title>
  
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>  <!-- jQuery 라이브러리 -->

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js"></script>

  <!-- FullCalendar 언어 설정 -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/css/calendar.css" rel="stylesheet" type="text/css">

  <!-- Axios 라이브러리 추가 -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    /* 일요일 날짜 셀에 대한 스타일을 설정 */
    .fc-day.fc-day-sun {
        color: red !important;        /* 색상 우선 적용 */
        font-weight: bold !important; /* 글씨 굵게 */
    }

    /* 일요일 요일 헤더에 대한 스타일을 설정 (요일은 굵게만) */
    .fc-col-header.fc-day-sun {
        font-weight: normal !important;  /* 일요일 헤더는 볼드가 아닌 기본 스타일 */
    }
  </style>
</head>

<body>
  <!-- 캘린더 영역 -->
  <div id="calendar"></div>

  <script>
    $(function () {
      var calendarEl = $('#calendar')[0];  // 캘린더 DOM 요소를 가져옴
      var calendar = new FullCalendar.Calendar(calendarEl, {

        googleCalendarApiKey: 'AIzaSyA9hP-FeR15xFjyPiVcEG8WRDJImyxfVpk',  // 구글 API 키 입력
        height: '700px',  // 캘린더 높이 설정
        initialView: 'dayGridMonth',  // 초기 화면: 월별 보기
        locale: 'ko',  // 한국어 설정
        editable: true,  // 일정 수정 가능
        droppable: true,
        dayMaxEvents: true,
        selectable: true,  // 날짜 선택 가능

        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        // 이벤트 소스 수정: events와 eventSources 병합을 하지 않음.
        eventSources: [
          {
            events: async function (info, successCallback, failureCallback) {
              try {
                // 기존 이벤트 목록을 가져오는 API 호출
                const eventResult = await axios.post('/calendar/api/events');
                const eventData = eventResult.data;
                const eventArray = eventData.map((event) => ({
                  title: event.title,
                  start: event.start,
                  end: event.end,
                  color: event.color,  // backgroundColor
                  id: event.id, // 이벤트 ID 추가
                }));
                successCallback(eventArray);  // 이벤트 배열을 FullCalendar에 전달
              } catch (error) {
                console.error('이벤트 로딩 실패', error);
                failureCallback(error);
              }
            },
          },
          {
            googleCalendarId: 'ko.south_korea.official#holiday@group.v.calendar.google.com',  // 공휴일 이벤트를 가져올 구글 캘린더 ID
            color: 'hotpink',  // 공휴일 이벤트의 배경색
            textColor: 'white',  // 공휴일 텍스트 색
          }
        ],

		eventClick: function(info) {
		  // 모달을 동적으로 로드
		  $('#eventModal').load('/changeEventModal.html', function() {
		    // 로드된 후에 모달의 폼에 기존 이벤트 정보 채우기
		    $('#eventTitle').val(info.event.title);
		    $('#eventStart').val(info.event.start.toISOString().slice(0, 16));
		    $('#eventEnd').val(info.event.end ? info.event.end.toISOString().slice(0, 16) : info.event.start.toISOString().slice(0, 16));
		    $('#eventColor').val(info.event.color);
		    $('#eventId').val(info.event.id);

		    // 모달 창 열기
		    $('#eventModal').modal('show');

		    // 삭제 버튼 클릭 시
		    $('#deleteEvent').off('click').on('click', function() {
		      axios.delete(`/calendar/${info.event.id}`)
		        .then(function(response) {
		          console.log('이벤트 삭제 성공');
		          info.event.remove();
		          calendar.refetchEvents();
		        })
		        .catch(function(error) {
		          console.error('삭제 실패', error);
		        });
		      $('#eventModal').modal('hide');
		    });

		    // 수정 버튼 클릭 시
		    $('#updateEvent').on('click', function() {
		      const updatedEvent = {
		        title: $('#eventTitle').val(),
		        start: $('#eventStart').val(),
		        end: $('#eventEnd').val() || $('#eventStart').val(),
		        color: $('#eventColor').val()
		      };

		      const eventId = $('#eventId').val();

		      if (!eventId) {
		        alert("Event ID가 없습니다!");
		        return;
		      }

		      $.ajax({
		        url: '/calendar/' + eventId,
		        method: 'PUT',
		        contentType: 'application/json',
		        data: JSON.stringify(updatedEvent),
		        success: function(response) {
		          alert('이벤트 수정 성공');
		          calendar.refetchEvents();
		        },
		        error: function(error) {
		          alert('이벤트 수정 실패');
		          console.error(error);
		        }
		      });
		    });
		  });
		},


        select: function (arg) {
          var title = prompt('일정 이름:');
          // 입력한 일정이 있을 경우
          if (title && title.trim() !== '') {
            // 색상을 선택하도록 유도하는 창을 띄움
            var color = prompt("색상을 선택하세요. (예: red, orange, yellow, green, blue, indigo, purple)", "blue");

            // 기본값을 "blue"로 설정
            if (!color || !['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'purple'].includes(color)) {
              color = 'blue';
            }
            // 새로운 일정 객체 생성
            var newEvent = {
              title: title,
              start: arg.start,  
              end: arg.end,
              color: color
            };

            // 서버로 새로운 일정을 저장하는 POST 요청 보내기
            axios.post('/calendar', newEvent)
              .then(function(response) {
                // 서버에 일정이 성공적으로 저장된 후, FullCalendar에 이벤트 추가
                calendar.addEvent(newEvent);				
              })
              .catch(function(error) {
                console.error('일정 저장 오류:', error);
              });
          }		
          calendar.unselect();  // 선택 상태 해제
        },
      });

      // 캘린더 렌더링
      calendar.render();
    });
  </script>

</body>
</html>
